<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Price Comparer - Login</title>
  <link rel="stylesheet" href="styles.css">

  <script>
    const STORAGE_KEYS = { auth: 'pc_auth' };

    const saveLS = (k, v) => {
      try { localStorage.setItem(k, JSON.stringify(v)); } catch {}
    };

    async function signUp(event) {
      event.preventDefault();
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;

      const resp = await fetch('/api/auth/sign-up', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await resp.json();
      if (data.error) {
        alert('Sign-Up Error: ' + data.error);
      } else {
        const raw = data.user.email.split("@")[0];
        const pretty = raw.charAt(0).toUpperCase() + raw.slice(1);

        saveLS(STORAGE_KEYS.auth, {
          mode: 'user',
          user: { ...data.user, name: pretty }
        });

        window.location.href = './index.html';
      }
    }

    async function signIn(event) {
      event.preventDefault();
      const email = document.getElementById('signin-email').value;
      const password = document.getElementById('signin-password').value;

      const resp = await fetch('/api/auth/sign-in', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await resp.json();
      if (data.error) {
        alert('Sign-In Error: ' + data.error);
      } else {
        const raw = data.user.email.split("@")[0];
        const pretty = raw.charAt(0).toUpperCase() + raw.slice(1);

        saveLS(STORAGE_KEYS.auth, {
          mode: 'user',
          user: { ...data.user, name: pretty }
        });

        window.location.href = './index.html';
      }
    }

    function guestMode() {
      saveLS(STORAGE_KEYS.auth, { mode: 'guest', user: null });
      window.location.href = './index.html';
    }
  </script>
</head>

<body class="login-body">

  <div class="login-card">

    <h1 class="app-title">Price Comparer</h1>

    <div class="tabs">
      <button class="tab-button active" onclick="switchTab('signin')">Sign In</button>
      <button class="tab-button" onclick="switchTab('signup')">Sign Up</button>
    </div>

    <!-- SIGN IN -->
    <section id="signin" class="tab-content visible">
      <form onsubmit="signIn(event)">
        <input id="signin-email" type="email" placeholder="Email" required>
        <input id="signin-password" type="password" placeholder="Password" required>
        <button class="primary-btn" type="submit">Sign In</button>
      </form>
    </section>

    <!-- SIGN UP -->
    <section id="signup" class="tab-content">
      <form onsubmit="signUp(event)">
        <input id="signup-email" type="email" placeholder="Email" required>
        <input id="signup-password" type="password" placeholder="Password" required>
        <button class="primary-btn" type="submit">Create Account</button>
      </form>
    </section>

    <div class="divider">Or</div>

    <button class="guest-btn" onclick="guestMode()">Continue as Guest</button>

  </div>

  <script>
    function switchTab(tab) {
      document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(sec => sec.classList.remove("visible"));

      document.querySelector(`.${tab === "signin" ? "tab-button:first-child" : "tab-button:last-child"}`).classList.add("active");
      document.getElementById(tab).classList.add("visible");
    }
  </script>

</body>
</html>
