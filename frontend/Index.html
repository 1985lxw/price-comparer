<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Price Comparer - App</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div id="root"></div>

  <script>

    (function(){
      try {
        const raw = localStorage.getItem('pc_auth');
        if (!raw) { window.location.replace('./login.html'); return; }
        const auth = JSON.parse(raw);
        if (!auth || !(auth.mode === 'user' || auth.mode === 'guest')) {
          window.location.replace('./login.html');
        }
      } catch (e) {
        window.location.replace('./login.html');
      }
    })();
  </script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;
    // hard coded values for now
    const STORAGE_KEYS = { auth: 'pc_auth', location: 'pc_location', shopping: 'pc_shopping_list' };
    const STORES = {
      '01003': ['Big Basket Amherst', 'Stop and Save', 'Value Mart'],
      '10001': ['Gotham Grocer', 'Uptown Foods', 'Eastside Fresh'],
      '02139': ['Charles Market', 'Cam Square Foods', 'Riverbank Grocer']
    };
    const PRODUCTS = [
      { q: 'eggs', variants: [
        { title: 'Large Eggs Grade A', size: '12 ct', unitPrice: '$0.25/egg' },
        { title: 'Organic Brown Eggs', size: '12 ct', unitPrice: '$0.38/egg' }
      ]},
      { q: 'milk', variants: [
        { title: 'Whole Milk', size: '1 gal', unitPrice: '$0.03/fl oz' },
        { title: '2 percent Milk', size: '1 gal', unitPrice: '$0.03/fl oz' }
      ]},
      { q: 'bread', variants: [
        { title: 'Wheat Bread', size: '20 oz', unitPrice: '$0.10/oz' },
        { title: 'Sourdough Loaf', size: '24 oz', unitPrice: '$0.12/oz' }
      ]},
      { q: 'rice', variants: [
        { title: 'Basmati Rice', size: '5 lb', unitPrice: '$0.90/lb' },
        { title: 'Jasmine Rice', size: '5 lb', unitPrice: '$0.82/lb' }
      ]},
    ];

    const saveLS = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };
    const readLS = (k,f)=>{ try{ const r=localStorage.getItem(k); return r?JSON.parse(r):f; }catch{ return f; } };
    const fmt = n => new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(n);

    function mockSearch(query, zip){
      const now = new Date();
      const stores = STORES[zip] || [];
      const base = PRODUCTS.find(p => p.q.includes(query.toLowerCase()));
      if(!base) return [];
      const out = [];
      for(const s of stores){
        for(const v of base.variants){
          const price = +(5 + Math.random()*8).toFixed(2);
          out.push({
            id: s+'-'+v.title,
            store: s,
            title: v.title,
            size: v.size,
            unitPrice: v.unitPrice,
            price,
            lastUpdated: now.toLocaleString()
          });
        }
      }
      return out;
    }

    function Button({children, className, ...props}){
      return (
        <button
          className={[
            'inline-flex items-center justify-center rounded-2xl px-4 py-2 text-sm font-medium shadow-sm',
            'bg-slate-900 text-white hover:bg-slate-800 active:bg-slate-950 focus:outline-none focus:ring-2 focus:ring-slate-400',
            className
          ].filter(Boolean).join(' ')}
          {...props}
        >
          {children}
        </button>
      );
    }
    function Input(props){
      return <input className="w-full rounded-2xl border border-slate-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-400" {...props} />;
    }
    function Select(props){
      return <select className="w-full rounded-2xl border border-slate-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-400" {...props} />;
    }
    function Card({children, className}){
      return <div className={["rounded-2xl border border-slate-200 bg-white p-4 shadow-sm", className].filter(Boolean).join(' ')}>{children}</div>;
    }

    function App(){
      const [auth] = useState(() => readLS(STORAGE_KEYS.auth, {mode:'guest', user:null}));
      const [zip, setZip] = useState(() => readLS(STORAGE_KEYS.location, '01003'));
      const [query, setQuery] = useState('');
      const [results, setResults] = useState([]);
      const [storeFilter, setStoreFilter] = useState('all');
      const [sortKey, setSortKey] = useState('price');
      const [sortDir, setSortDir] = useState('asc');
      const [shopping, setShopping] = useState(() => readLS(STORAGE_KEYS.shopping, []));
      const [showList, setShowList] = useState(false);

      useEffect(()=> saveLS(STORAGE_KEYS.location, zip), [zip]);
      useEffect(()=> saveLS(STORAGE_KEYS.shopping, shopping), [shopping]);

      const stores = useMemo(()=> STORES[zip] || [], [zip]);

      const filteredSorted = useMemo(()=>{
        let rows = results;
        if(storeFilter !== 'all') rows = rows.filter(r=>r.store === storeFilter);
        const dir = sortDir === 'asc' ? 1 : -1;
        return [...rows].sort((a,b)=>{
          if(sortKey==='price') return (a.price - b.price)*dir;
          if(sortKey==='store') return a.store.localeCompare(b.store)*dir;
          return a.title.localeCompare(b.title)*dir;
        });
      }, [results, storeFilter, sortKey, sortDir]);

      const total = useMemo(()=> shopping.reduce((s,it)=> s + (it.price||0), 0), [shopping]);

      function handleSearch(){
        if(!query.trim()) return;
        setResults(mockSearch(query.trim(), zip));
      }
      function addToList(row){
        setShopping(prev => prev.find(x=>x.id===row.id) ? prev : [...prev, row]);
      }
      function removeFromList(id){
        setShopping(prev => prev.filter(x=>x.id!==id));
      }
      function logout(){
        localStorage.removeItem('pc_auth');
        window.location.replace('./login.html');
      }

      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-40 border-b border-slate-200 bg-white/90 backdrop-blur">
            <div className="mx-auto flex max-w-6xl items-center justify-between gap-3 px-4 py-3">
              <div className="flex items-center gap-3">
                <div className="flex h-9 w-9 items-center justify-center rounded-2xl bg-slate-900 text-white">$</div>
                <div>
                  <div className="text-sm font-semibold">Price Comparer</div>
                </div>
              </div>

              <div className="flex items-center gap-2">
                <Select aria-label="Zip selector" value={zip} onChange={e=>setZip(e.target.value)}>
                  {Object.keys(STORES).map(code => <option key={code} value={code}>{code}</option>)}
                </Select>
                <Button onClick={()=>setShowList(true)}>Shopping List ({shopping.length})</Button>
                {auth.mode==='guest' ? (
                  <a href="./login.html" className="rounded-2xl border border-slate-300 px-4 py-2 text-sm hover:bg-slate-50">Log in</a>
                ) : (
                  <div className="flex items-center gap-2">
                    <span className="hidden text-sm text-slate-700 sm:block">Hi {auth.user?.name || 'User'}</span>
                    <button onClick={logout} className="rounded-2xl border border-slate-300 px-4 py-2 text-sm hover:bg-slate-50">Log out</button>
                  </div>
                )}
              </div>
            </div>
          </header>

          <main className="mx-auto max-w-6xl px-4 pb-24 pt-8">
            <Card className="mb-4">
              <div className="flex flex-col gap-3 sm:flex-row sm:items-end">
                <div className="flex-1">
                  <label className="mb-1 block text-sm">Search items</label>
                  <Input
                    placeholder="Try eggs, milk, bread"
                    value={query}
                    onChange={e=>setQuery(e.target.value)}
                    onKeyDown={e=>{ if(e.key==='Enter') handleSearch(); }}
                  />
                </div>
                <div className="flex items-center gap-2">
                  <Button onClick={handleSearch}>Search</Button>
                </div>
              </div>
              <div className="mt-3 text-xs text-slate-500">Stores for {zip}: {stores.join(', ') || 'None'}</div>
            </Card>

            <Card>
              <div className="mb-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div className="text-sm font-medium">Results</div>
                <div className="flex flex-wrap items-center gap-2">
                  <Select value={storeFilter} onChange={e=>setStoreFilter(e.target.value)}>
                    <option value="all">All stores</option>
                    {stores.map(s => <option key={s} value={s}>{s}</option>)}
                  </Select>
                  <Select value={sortKey} onChange={e=>setSortKey(e.target.value)}>
                    <option value="price">Sort by price</option>
                    <option value="store">Sort by store</option>
                    <option value="title">Sort by product</option>
                  </Select>
                  <Select value={sortDir} onChange={e=>setSortDir(e.target.value)}>
                    <option value="asc">Asc</option>
                    <option value="desc">Desc</option>
                  </Select>
                </div>
              </div>

              <div className="overflow-x-auto">
                <table className="min-w-full text-left text-sm">
                  <thead>
                    <tr className="border-b bg-slate-50 text-slate-600">
                      <th className="px-3 py-2">Store</th>
                      <th className="px-3 py-2">Product</th>
                      <th className="px-3 py-2">Size</th>
                      <th className="px-3 py-2">Unit</th>
                      <th className="px-3 py-2">Price</th>
                      <th className="px-3 py-2">Last updated</th>
                      <th className="px-3 py-2">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredSorted.length===0 ? (
                      <tr><td colSpan="7" className="px-3 py-6 text-center text-slate-500">No results yet. Search to see prices.</td></tr>
                    ) : (
                      filteredSorted.map(row => (
                        <tr key={row.id} className="border-b last:border-b-0">
                          <td className="px-3 py-2 align-top">{row.store}</td>
                          <td className="px-3 py-2 align-top">{row.title}</td>
                          <td className="px-3 py-2 align-top">{row.size}</td>
                          <td className="px-3 py-2 align-top">{row.unitPrice}</td>
                          <td className="px-3 py-2 align-top">{fmt(row.price)}</td>
                          <td className="px-3 py-2 align-top">{row.lastUpdated}</td>
                          <td className="px-3 py-2 align-top">
                            <Button className="px-3 py-1 text-xs" onClick={()=> addToList(row)}>Add</Button>
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </Card>
          </main>

          {showList && (
            <div className="fixed inset-0 z-50 flex items-start justify-end bg-black/40">
              <div className="h-full w-full max-w-lg overflow-y-auto bg-white p-4 shadow-xl">
                <div className="mb-3 flex items-start justify-between">
                  <div>
                    <h2 className="text-lg font-semibold">Shopping List</h2>
                    <div className="text-xs text-slate-500">Items saved on this device</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <button onClick={()=>{
                      const lines = shopping.map(r => `${r.title} @ ${r.store} - ${fmt(r.price)} (${r.size})`).join('%0A');
                      const body = `My shopping list%0A%0A${lines}%0A%0ATotal: ${fmt(total)}`;
                      window.location.href = `mailto:?subject=Shopping list&body=${body}`;
                    }} className="rounded-2xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">Email</button>
                    <button onClick={()=>{
                      const header = ['Store','Product','Size','Unit Price','Price','Last Updated'];
                      const lines = [header.join(',')];
                      shopping.forEach(r=>{
                        lines.push([r.store, '"'+r.title.replaceAll('"','""')+'"', r.size, r.unitPrice, r.price, r.lastUpdated].join(','));
                      });
                      const csv = lines.join('\n');
                      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
                      const url = URL.createObjectURL(blob);
                      const a = document.createElement('a');
                      a.href = url; a.download = `shopping_list_${Date.now()}.csv`; a.click();
                      setTimeout(()=> URL.revokeObjectURL(url), 1000);
                    }} className="rounded-2xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">Save CSV</button>
                    <button onClick={()=>setShowList(false)} className="rounded-2xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">Close</button>
                  </div>
                </div>

                <div className="mb-3 flex items-center justify-between">
                  <div className="text-sm">Total: <span className="font-semibold">{fmt(total)}</span></div>
                  <button onClick={()=>setShopping([])} className="text-sm text-rose-600 hover:underline">Clear all</button>
                </div>

                {shopping.length===0 ? (
                  <Card><div className="text-sm text-slate-600">Your list is empty.</div></Card>
                ) : (
                  <div className="space-y-2">
                    {shopping.map(item => (
                      <Card key={item.id} className="flex items-start justify-between gap-3">
                        <div>
                          <div className="font-medium">{item.title}</div>
                          <div className="text-xs text-slate-500">{item.store} • {item.size} • {item.unitPrice}</div>
                          <div className="mt-1 text-sm">{fmt(item.price)} <span className="text-xs text-slate-500">Last updated {item.lastUpdated}</span></div>
                        </div>
                        <button onClick={()=> removeFromList(item.id)} className="rounded-2xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">Remove</button>
                      </Card>
                    ))}
                  </div>
                )}

                <div className="mt-6 border-t pt-4 text-xs text-slate-500">
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
